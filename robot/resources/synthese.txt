*** Settings ***
Documentation     Bla bla bla
Library           RequestsLibrary

*** Variables ***
${S3_SERVER}      /home/mjambert/Workspace/rcs/git/synthese3/build/src/bin/server/s3-server
${S3_SERVER_DB}    config.db3
${S3_SERVER_PORT}    8080
${S3_SERVER_URL}    http://localhost:${S3_SERVER_PORT}/

*** Keywords ***
Start Synthese
    Start Process    ${S3_SERVER}    '--param port\=8084 --param log_level=0'    stderr=${SUITE NAME}_s3.err    stdout=${SUITE NAME}_s3.out
    Wait Until Keyword Succeeds    2 min    5 sec    Open Connection    localhost    ${None}    ${S3_SERVER_PORT}

Stop Synthese
    Terminate Process

Create Synthese Object
    [Arguments]    ${tableId}    @{varargs}
    ${httpResponse}=    Call Synthese Service    objectcreate    table_id\=${tableId}    @{varargs}
    [Return]    ${httpResponse}

Delete Synthese Object
    [Arguments]    ${objectId}
    ${httpResponse}=    Call Synthese Action    RemoveObjectAction    actionParam_object_id\=${objectId}
    Should Be Equal As Strings    ${httpResponse.status_code}    200

Update Synthese Object
    [Arguments]    ${objectId}   @{varargs}
    ${httpResponse}=    Call Synthese Action    ObjectUpdate    actionParam_object_id\=${objectId}    @{varargs}
    Should Be Equal As Strings    ${httpResponse.status_code}    200

Delete Synthese Objects
    [Arguments]    ${tableName}
    Connect To Database Using Custom Params    sqlite3   database="./config.db3"
    @{queryResults}=   Query    SELECT id FROM ${tableName};
    :FOR   ${id}   in    @{queryResults}    
    \   Delete Synthese Object   ${id[0]}
    Disconnect From Database
    
Process Alerts
    ${httpResponse}=    Call Synthese Action    ProcessAlertsAction
    Should Be Equal As Strings    ${httpResponse.status_code}    200

Call Synthese Service
    [Arguments]    ${serviceName}    @{varargs}
    Create Session    synthese    ${S3_SERVER_URL}
    ${serviceParameters}=    Catenate    SEPARATOR=&    @{varargs}
    ${httpResponse}=    Get Request    synthese    ?SERVICE=${serviceName}&${serviceParameters}
    [Return]    ${httpResponse}

Call Synthese Action
    [Arguments]    ${actionName}    @{varargs}
    Create Session    synthese    ${S3_SERVER_URL}
    ${actionParameters}=    Catenate    SEPARATOR=&    @{varargs}
    ${httpResponse}=    Get Request    synthese    ?SERVICE=version&a=${actionName}&${actionParameters}
    [Return]    ${httpResponse}
