<project name="synthese" default="all" basedir=".">

  <import file="../common.xml"/>

  <property name="version" value="3_0"/>
  <property name="lang" value="c++"/>
  
  <property name="include.home" value="${src.home}"/>
  <property name="deploy.local.lib.regexp.from" value="(.*)"/>
  <property name="deploy.local.lib.regexp.to" value="\1"/>

  <property name="target" value="src/main/98_synthese_sai,src/main/99_synthese_vinci,src/main/91_cgi_client,src/main/95_db_client"/>     



  <target name="build">


    <for param="targ" list="${target}">
       <sequential>

	 <antcall target="sconsbuild">
	   <param name="goal" value="build"/>
	   <param name="target" value="@{targ}"/>
	   <param name="profile" value="false"/>
	 </antcall>

       </sequential>
    </for>
       
  </target>
       
       
  <target name="dist">


    <for param="targ" list="${target}">
       <sequential>
	 <propertyregex property="distname" input="@{targ}" casesensitive="false"
			regexp="^.*/(.*)" select="\1" override="true"/>
	 <var name="distdir" 
		   value="${dist.home}/${distname}_${platform}_${toolset}_${mode}"/>


	 <antcall target="sconsbuild">
	   <param name="goal" value="dist"/>
	   <param name="target" value="@{targ}"/>
	   <param name="profile" value="false"/>
	 </antcall>
	 
	 <if>
	   <and>
	     <equals arg1="${platform}" arg2="posix"/>
	     <equals arg1="${mode}" arg2="release"/>
	   </and>
	   <then>
	     <echo message="Stripping ${distdir}/${distname}"/>
	     <exec executable="strip" failonerror="true" 
		   resolveexecutable="true" searchpath="true">
	       <arg value="${distdir}/${distname}"/>
	     </exec>       
	   </then>
	 </if>
	 
	 <delete file="${distdir}.zip"/> 
	 <zip destfile="${distdir}.zip"> 
	   
	   <zipfileset filemode="755" dir="${dist.home}" 
		       includes="${distname}_${platform}_${mode}/${distname},
				 ${distname}_${platform}_${mode}/**/*.sh"/>
	   
	   <zipfileset dir="${dist.home}"
		       includes="${distname}_${platform}_${mode}/**"
		       excludes="${distname}_${platform}_${mode}/${distname},
				 ${distname}_${platform}_${mode}/**/*.sh"/>
	   
	 </zip>

       </sequential>
    </for>

  </target>


  <target name="deploy">
  </target>


</project>

