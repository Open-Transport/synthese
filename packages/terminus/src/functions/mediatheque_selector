<div class="row-fluid">
  <div id ="folders-zone" class="span3">
  </div>
  <@folder_data_id=<?if&cond=<@folder_id@>&then=data-id="<@folder_id@>"?>@>
  <div class="span9">
    <div class="form-search well well-small">
      <input type="text" name="file_search" value="<@file_search@>" placeholder="Nom du fichier">
      <button id="search-button" class="btn btn-primary holder-folder-id" <@folder_data_id@> data-file-action="reloadFilesList">Rechercher</button>
      <div id="view-mode" data-active-mode="<@view_mode?1:0@>" class="btn-group btn-group-xs pull-right" data-toggle="buttons-radio">
        <button type="button" class="btn btn-primary holder-folder-id view-mode-button<@view_mode?"":" active"@>" data-mode="0" <@folder_data_id@> data-file-action="reloadFilesList">
          <i class="icon-th-large icon-white"></i>
        </button>
        <button type="button" class="btn btn-primary holder-folder-id view-mode-button<@view_mode?" active":""@>" data-mode="1" <@folder_data_id@> data-file-action="reloadFilesList">
          <i class="icon-list icon-white"></i>
        </button>
      </div>
    </div>
    <div id="files-zone">
      <div id="loader">
        <div class="loader-text">Chargement en cours</div>
      </div>
      <div id="files-list">
        <div class='alert alert-info'>Aucun élément n'est présent dans ce répertoire.</div>
      </div>
      <div id="file-actions"<@folder_id?"":" style=\"display: none\""@>>
        <?if&cond=<@admin_mediatheque@>&then=<hr><a data-form-action="uploadFile" <@folder_data_id@> class="btn btn-primary pull-right holder-folder-id">Uploader</a>?>
      </div>
    </div>
  </div>
  <script>
  function changeMedialibraryId() {
    var media_id = $(this).val();
    $('#selectMediaLibrary').attr('data-id', media_id);
    $('#selectMediaLibrary').attr('data-website-id', $(this).attr('data-website-id'));
    loadFoldersList(media_id);
  }
  function loadFoldersList(active_media_id, active_folder_id) {
      $.ajax({
        type: 'GET',
        url: "/terminus/list_folders",
        data: { folder_id: active_folder_id,
                medialibrary_id: active_media_id,
                admin_mediatheque: $('#admin_mediatheque').length
              }
        })
        .done(function (data, status) {
          if (status == "success") {
            $('#folders-zone').html(data);
            changeListFiles(null, active_folder_id);
          } else {
            addAlert();
          }
        })
        .fail(function (data, status, error) {
          addAlert();
        });
    }
    function changeListFiles(event, active_folder_id) {
      var elem = $(this);
      if (!elem.attr('data-id') && typeof active_folder_id != 'undefined') {
        elem = $('#folders-list').find('[data-id='+active_folder_id+']');
      }
      if (elem.attr('data-id')) {
        // Copy folder id to live action buttons
        $('.holder-folder-id').attr('data-id', elem.attr('data-id'));
        $('#files-list').hide();
        $('#loader').show();
        $.ajax({
          type: 'GET',
          url: "/terminus/list_files",
          data: { folder_id: elem.attr('data-id'),
                  medialibrary_id: $('#selectMediaLibrary').attr('data-id'),
                  admin_mediatheque: $('#admin_mediatheque').length,
                  file_search: $('[name="file_search"]').val(),
                  view_mode: $('#view-mode').attr('data-active-mode') },
        })
            .done(function (data, status) {
              if (status == "success") {
                elem.parent().parent().children('.active').find('.folder-actions').hide();
                elem.parent().parent().children('.active').removeClass('active');
                elem.parent().addClass('active');
                elem.parent().find('.folder-actions').show();
                $('#files-list').html(data);
              } else {
                addAlert();
              }
            })
            .fail(function (data, status, error) {
              addAlert();
            })
            .always(function(data, status, error) {
              $('#loader').hide();
              $('#files-list').show();
              $('#file-actions').show();
            });
      } else {
        $('.holder-folder-id').removeAttr('data-id');
        $('#file-actions').hide();
        $('#files-list').html("<div class='alert alert-info'>Aucun élément n'est présent dans ce répertoire.</div>");
        $('#folders-list').children('.active').find('.folder-actions').hide();
        $('#folders-list').children('.active').removeClass('active');
        $('#folders-root').addClass('active');
        $('#folders-root').find('.folder-actions').show();
      }
    }
<?if&cond=<@admin_mediatheque@>&else=
    function selectFile(event, item) {
      var elem = $(this);
      if (typeof item != 'undefined') { elem = item; };
      $('.thumbnail-selectable.active').removeClass('active');
      elem.addClass('active');
    }
    function submitFileForm() {
      var pictureLink = $('.thumbnail-selectable.active');
      if (pictureLink.length > 0) {
        var ed = tinyMCE.get('tinymce');
        var range = ed.selection.getRng();
        var newNode = ed.getDoc().createElement("img");
        newNode.src = pictureLink.children('img').attr('src');
        range.insertNode(newNode);
      }
    }
    function selectAndSubmitFileForm(event) {
      selectFile(event, $(this));
      submitFileForm();
      $('#m_image').modal('hide');
    }
?>
    function addAlert() {
      if ($('#files-list').find('.alert').length > 0) {
        $('#files-list').find('.alert').last().after("<div class='alert alert-error'>Une erreur est survenue lors de l'opération.</div>");
      } else {
        $('#files-list').html("<div class='alert alert-error'>Une erreur est survenue lors de l'opération.</div>");
      }
    }
    $(function(){
      $('.view-mode-button').click(function () {
        $('#view-mode').attr('data-active-mode', $(this).attr('data-mode'));
      });
      $(document).on('change', '#selectMediaLibrary', changeMedialibraryId);
      $(document).on('click', '[data-file-action="reloadFilesList"]', changeListFiles);
<?if&cond=<@admin_mediatheque@>&then=
      loadFoldersList("<@medialibrary_id@>"<?if&cond=<@folder_id@>&then=, "<@folder_id@>"?>);
&else=
      loadFoldersList();
      $(document).on('click', '[data-file-action="selectFile"]', selectFile);
      $(document).on('dblclick', '[data-file-action="selectFile"]', selectAndSubmitFileForm);
      $(document).on('click', '[submit="m_image"]', submitFileForm);
?>
    });
  </script>
</div>
