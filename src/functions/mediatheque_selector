<div class="row-fluid">
  <div class="span3">
    <ul class="nav nav-list well folders-list">
      <?menu&root=<@~global("website_media_id")@>&raw_data=1&min_depth=0&max_depth=9999&template=
      <li<@folder_id?"":" class=\"active\""@>>
      <?if&cond=<@folder_id@>
      &then=<?link&target=<@p@>&text=Multimédia?>
      &else=<a href="#" data-action="reloadFilesList">Multimédia</a>
      ?>
      </li>
      <{page&recursive=1&template=
      <?if&cond=<@mime_type=="/"@>&then=
      <li class="tree_<@depth+1@><?if&cond=<@id==<@folder_id@>@>&then= active?>" file_id="<@id@>" file_type="<@mime_type@>" file_path="<@smart_url_path@>">
        <a href="#" data-id="<@id@>" data-action="reloadFilesList"><@title@> - <@smart_url_path@></a>
      </li>
      ?>
      <@recursive_content@>
      }>
      ?>
    </ul>
  </div>
  <div class="span9 list-files">
    <div class='alert alert-info'>Aucun élément n'est présent dans ce répertoire.</div>
  </div>
  <div id="loader"><div class="loader-text">Chargement en cours</div></div>
  <script>
    function changeListFiles() {
      var elem = $(this);
      if (elem.attr('data-id')) {
        $('#loader').show();
        $.ajax({
          type: 'GET',
          url: "/terminus/list_files",
          data: { folder_id: elem.attr('data-id')}
        })
            .done(function (data, status) {
              if (status == "success") {
                elem.parent().parent().children('.active').removeClass('active');
                elem.parent().addClass('active');
                $('.list-files').html(data);
              } else {
                addAlert();
              }
            })
            .fail(function (data, status, error) {
              addAlert();
            })
            .always(function(data, status, error) {
              $('#loader').hide();
            });
      } else {
        $('.list-files').html("<div class='alert alert-info'>Aucun élément n'est présent dans ce répertoire.</div>");
        $('.folders-list').children('.active').removeClass('active');
        $('.folders-list').children().first().addClass('active');
      }
    }
    function selectFile() {
      var elem = $(this);
      $('.thumbnail.selected').removeClass('selected');
      elem.addClass('selected');
    }
    function submitFileForm() {
      var pictureLink = $('.thumbnail.selected');
      if (pictureLink.length > 0) {
        var ed = tinyMCE.get('tinymce');
        var range = ed.selection.getRng();
        var newNode = ed.getDoc().createElement("img");
        newNode.src = pictureLink.children('img').attr('src');
        range.insertNode(newNode);
        changeListFiles();
      }
    }
    function addAlert() {
      if ($('.list-files').find('.alert').length > 0) {
        $('.list-files').find('.alert').last().after("<div class='alert alert-error'>Une erreur est survenue lors de l'opération.</div>");
      } else {
        $('.list-files').html("<div class='alert alert-error'>Une erreur est survenue lors de l'opération.</div>");
      }
    }
    $(function(){
      $('[data-action="reloadFilesList"]').click(changeListFiles);
      $('[data-action="selectFile"]').live('click', selectFile);
      $('[submit="m_image"]').live('click', submitFileForm);
    });
  </script>
</div>