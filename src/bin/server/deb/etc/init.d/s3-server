#!/bin/bash


NAME=s3-server

source /etc/opt/rcs/$NAME.conf

DAEMON=/opt/rcs/bin/$NAME

test -x $DAEMON || exit 0

# delete stale pid file if any
(pgrep -P 1 ${NAME:0:15} >& /dev/null) || (rm -f $S3_SERVER_PID_FILE)

case "$1" in

    start)
	echo "Starting $NAME server... "
	($DAEMON --daemon --pidfile $S3_SERVER_PID_FILE --logfile $S3_SERVER_LOG_FILE --db $S3_SERVER_DB_FILE --param tmp_dir=$S3_SERVER_TMP_DIR --param port=$S3_SERVER_PORT --param db_port=$S3_SERVER_DB_PORT --param log_level=$S3_SERVER_LOG_LEVEL --param dbring_node_id=$S3_SERVER_NODE_ID --param dbring_authority=$S3_SERVER_AUTHORITY_NODE_ID) || (echo "Failed!" && exit 1)
	;;
    stop)
	echo "Stopping $NAME server... "
	test -f $S3_SERVER_PID_FILE && kill -15 `cat $S3_SERVER_PID_FILE`
	pkill -P 1 ${NAME:0:15} >& /dev/null
	;;
    restart)
	$0 stop
	sleep 1
	$0 start
	;;
    status)
	(test -r $S3_SERVER_PID_FILE && echo "Process $NAME is running with pid $(cat $S3_SERVER_PID_FILE).") || echo "$NAME server is not running."
	;;
    *)
	echo "Usage: $0 start|stop|restart|status" >&2
	exit 1
	;;
esac

exit 0

